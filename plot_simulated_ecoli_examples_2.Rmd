---
title: "Simulated E. coli examples"
author: "Gerry Tonkin-Hill"
date: "`r Sys.Date()`"
output: 
  html_document:
    fig_width: 12
    fig_height: 8
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.width=20, fig.height=12,
                      echo=TRUE, warning=FALSE, message=FALSE,
                      tidy=TRUE)
options(stringsAsFactors = FALSE)
```

##Load Libraries and Download Data

```{r, warning=FALSE, message=FALSE}
library(ggplot2)
library(data.table)
library(purrr)
library(RColorBrewer)
library(stringr)
library(patchwork)
library(piggyback)
```

```{r, eval=FALSE}
pb_download("simulated_data.zip", 
            repo = "gtonkinhill/panaroo_manuscript", 
            dest = "./")
unzip("simulated_data.zip")
```


##Load data

Initially load the various presence/absence files generated by the different pangenome inference algorithms.

```{r, eval=FALSE}
sim_pa_files <- Sys.glob("./simulated_data/realistic_sims/sim_pa_files/*.csv")
sim_pa <- map(sim_pa_files, ~ fread(.x, data.table = FALSE))
names(sim_pa) <- map_chr(sim_pa_files, ~ tools::file_path_sans_ext(basename(.x)))

roary_inferred_pa_files <- Sys.glob("./simulated_data/realistic_sims/roary_pa_files/*.csv")
roary_pa <- map(roary_inferred_pa_files, ~ fread(.x, data.table = FALSE))
names(roary_pa) <- map_chr(roary_inferred_pa_files, ~ tools::file_path_sans_ext(basename(.x)))

pirate_inferred_pa_files <- Sys.glob("./simulated_data/realistic_sims/pirate_pa_files/*.csv")
pirate_pa <- map(pirate_inferred_pa_files, ~ fread(.x, data.table = FALSE))
names(pirate_pa) <- map_chr(pirate_inferred_pa_files, ~ tools::file_path_sans_ext(basename(.x)))

panx_inferred_pa_files <- Sys.glob("./simulated_data/realistic_sims/panx_pa_files/*.csv")
panx_pa <- map(panx_inferred_pa_files, ~ fread(.x, data.table = FALSE))
names(panx_pa) <- map_chr(panx_inferred_pa_files, ~ tools::file_path_sans_ext(basename(.x)))

panaroo_inferred_pa_files <- Sys.glob("./simulated_data/realistic_sims/panaroo_pa_files/*.csv")
panaroo_pa <- map(panaroo_inferred_pa_files, ~ fread(.x, data.table = FALSE))
names(panaroo_pa) <- map_chr(panaroo_inferred_pa_files, ~ tools::file_path_sans_ext(basename(.x)))
```

```{r}
assem_mapping <- fread("./simulated_data/realistic_sims/assem_mapping.csv", data.table = FALSE)
cf_assem_mapping <- fread("./simulated_data/realistic_sims/cf_assem_mapping.csv", data.table = FALSE)
```

##Format

We need to get everything into a similar format to allow us to compare the results of the different algorithms. This isn't particularly pretty.

```{r, eval=FALSE}
# format Roary output
roary_pa <- imap(roary_pa, function(pa, fname){
  print(fname)
  
  temp <- pa[,15:ncol(pa)]
  
  # set up mapping vectors
  if (grepl(".*art_assem.*", fname)){
    keep <- cf_assem_mapping$folder==gsub("roary_.*_pa_", "", fname)
    lookup <- cf_assem_mapping$annotation[keep]
    names(lookup) <- paste(cf_assem_mapping$file[keep], cf_assem_mapping$id[keep], sep="_")
  } else {
    keep <- assem_mapping$folder==gsub("roary_.*_pa_", "", fname)
    lookup <- assem_mapping$annotation[keep]
    names(lookup) <- paste(assem_mapping$file[keep], assem_mapping$id[keep], sep="_")
  }
  lookup[is.na(lookup)] <- "unannotated"
  
  pa <- do.call(cbind, map(1:ncol(temp), function(i){
    lookup[paste(colnames(temp)[[i]], temp[,i], sep="_")]
  }))
  
  colnames(pa) <- colnames(temp)
  pa <- pa[,order(as.numeric(gsub(".*iso", "", gsub(".*iso_", "", colnames(pa)))))]
  pa[is.na(pa)] <- ""
  pa[pa=="unannotated"] <- NA
  return(pa)
})
saveRDS(roary_pa, file = "roary_pa.RDS")

# format Panaroo output
panaroo_pa <- imap(panaroo_pa, function(pa, fname){
  print(fname)
  temp <- pa[,15:ncol(pa)]
  
  # set up mapping vectors
  if (grepl(".*art_assem.*", fname)){
    keep <- cf_assem_mapping$folder==gsub(".*_pa_", "", fname)
    lookup <- cf_assem_mapping$annotation[keep]
    names(lookup) <- paste(cf_assem_mapping$file[keep], cf_assem_mapping$id[keep], sep="_")
  } else {
    keep <- assem_mapping$folder==gsub(".*_pa_", "", fname)
    lookup <- assem_mapping$annotation[keep]
    names(lookup) <- paste(assem_mapping$file[keep], assem_mapping$id[keep], sep="_")
  }
  lookup[is.na(lookup)] <- "unannotated"
  
  # pat <- do.call(cbind, map(1:ncol(temp), function(i){
  #   lookup[paste(colnames(temp)[[i]], temp[,i], sep="_")]
  # }))
  pa <- do.call(cbind, map(1:ncol(temp), function(i){
    is_split <- grepl(".*;.*", temp[,i])
    is_refound <- grepl(".*refound.*", temp[,i])
    nr <- lookup[paste(colnames(temp)[[i]], temp[,i], sep="_")]
    nr[is_split] <- map_chr(str_split(temp[is_split,i], ";"), ~ paste(lookup[paste(colnames(temp)[[i]], .x, sep="_")], collapse=";"))
    nr[is_refound] <- "unannotated"
    return(nr)
  }))
  
  colnames(pa) <- colnames(temp)
  pa <- pa[,order(as.numeric(gsub(".*iso", "", gsub(".*iso_", "", colnames(pa)))))]
  pa[is.na(pa)] <- ""
  pa[pa=="unannotated"] <- NA
  return(pa)
})
saveRDS(panaroo_pa, file = "panaroo_pa.RDS")

# format PanX
panx_pa <- imap(panx_pa, function(pa, fname){
  print(fname)
  temp <- pa

  # set up mapping vectors
  if (grepl(".*art_assem.*", fname)){
    keep <- cf_assem_mapping$folder==gsub(".*_pa_", "", fname)
    lookup <- cf_assem_mapping$annotation[keep]
    names(lookup) <- paste(gsub("-","",cf_assem_mapping$file[keep]), cf_assem_mapping$locus_tag[keep], sep="_")
  } else {
    keep <- assem_mapping$folder==gsub(".*_pa_", "", fname)
    lookup <- assem_mapping$annotation[keep]
    names(lookup) <- paste(gsub("-","",assem_mapping$file[keep]), assem_mapping$locus_tag[keep], sep="_")
  }
  lookup[is.na(lookup)] <- "unannotated"
  
  pa <- do.call(cbind, map(1:ncol(temp), function(i){
    lookup[paste(colnames(temp)[[i]], temp[,i], sep="_")]
  }))
  
  colnames(pa) <- colnames(temp)
  colnames(pa) <- gsub("e", "e-", colnames(pa))
  pa <- pa[,order(as.numeric(gsub(".*iso", "", gsub(".*iso_", "", colnames(pa)))))]
  pa[is.na(pa)] <- ""
  pa[pa=="unannotated"] <- NA
  return(pa)
})
saveRDS(panx_pa, file = "panx_pa.RDS")

# format PIRATE
pirate_pa <- imap(pirate_pa, function(pa, fname){
  print(fname)
  temp <- pa[,23:ncol(pa)]

  # set up mapping vectors
  if (grepl(".*art_assem.*", fname)){
    keep <- cf_assem_mapping$folder==gsub(".*_pa_", "", fname)
    lookup <- cf_assem_mapping$annotation[keep]
    names(lookup) <- paste(gsub("-","_",cf_assem_mapping$file[keep]), cf_assem_mapping$id[keep], sep="_")
  } else {
    keep <- assem_mapping$folder==gsub(".*_pa_", "", fname)
    lookup <- assem_mapping$annotation[keep]
    names(lookup) <- paste(gsub("-","_",assem_mapping$file[keep]), assem_mapping$id[keep], sep="_")
  }
  lookup[is.na(lookup)] <- "unannotated"
  
  temp <- as.matrix(temp)
  pa <- do.call(cbind, map(1:ncol(temp), function(i){
    is_split <- grepl(".*;.*", temp[,i])
    nr <- lookup[paste(colnames(temp)[[i]], temp[,i], sep="_")]
    nr[is_split] <- map_chr(str_split(temp[is_split,i], ";"), ~ paste(lookup[paste(colnames(temp)[[i]], .x, sep="_")], collapse=";"))
    return(nr)
  }))
  
  colnames(pa) <- colnames(temp)
  colnames(pa) <- gsub("e", "e-", colnames(pa))
  pa <- pa[,order(as.numeric(gsub(".*iso", "", gsub(".*iso_", "", colnames(pa)))))]
  pa[is.na(pa)] <- ""
  pa[pa=="unannotated"] <- NA
  return(pa)
})
saveRDS(pirate_pa, file = "pirate_pa.RDS")

# format original simulation matrix
sim_pa <- map(sim_pa, function(pa){
  pa <- t(apply(pa, 1, function(r){
    temp <- r[2:ncol(pa)]
    temp[temp==1] <- r[[1]]
    temp[temp==0] <- ""
    return(temp)
  }))
  pa <- pa[,order(as.numeric(gsub(".*iso", "", colnames(pa))))]
})
saveRDS(sim_pa, file = "sim_pa.RDS")
```

Load pre-processed RDS files

```{r}
panaroo_pa <- readRDS(file = "panaroo_pa.RDS")
roary_pa <- readRDS(file = "roary_pa.RDS")
panx_pa <- readRDS(file = "panx_pa.RDS")
pirate_pa <- readRDS(file = "pirate_pa.RDS")
sim_pa <- readRDS(file = "sim_pa.RDS")
```


Identical paralogs can cause issues in our simulation as we identify genes using exact sequence matching, by running Prokka with a custom BLAST database containing the simulated gene sequences. Thus if two genes are identical and unmutated their labels may not be distinct. We resolve this by ignoring genes that are annotated as being the same in the same isolate. This can only occur in this scenario.

```{r}
paralogs <- unique(c(unlist(map(roary_pa, ~ apply(.x, 2, function(pa){unique(pa[duplicated(pa)])}))),
                     unlist(map(panx_pa, ~ apply(.x, 2, function(pa){unique(pa[duplicated(pa)])}))),
                       unlist(map(pirate_pa, ~ apply(.x, 2, function(pa){unique(pa[duplicated(pa)])}))),
                         unlist(map(panaroo_pa, ~ apply(.x, 2, function(pa){unique(pa[duplicated(pa)])})))))
paralogs <- paralogs[(!is.na(paralogs)) & (paralogs!="")]
```

```{r}
count_errors <- function(m1, m2, missing, paralogs){
  
  # deal with cases when PIRATE or panaroo merge the original IDs
  # this is usually due to a poor call in the original annotation and so
  # the merge should be counted as correct
  
  # needs_splitting <- rowSums(matrix(grepl(".*;.*", m2), nrow = nrow(m2)))>0
  # if (sum(needs_splitting)>0){
  #   split_back <- do.call(rbind, map(which(needs_splitting), function(r) {
  #     x <- m2[r, ]
  #     ids <- str_split(x, ";")
  #     unique_ids <- unique(unlist(ids))
  #     return(do.call(rbind, map(unique_ids, function(id){
  #       nr <- rep("", length(ids))
  #       has_refound <- map_lgl(ids, ~ any(grepl(".*refound.*", .x)))
  #       nr[map_lgl(ids, ~ id %in% .x)] <- id
  #       nr[has_refound] <- NA
  #       return(nr)
  #     })))
  #   }))
  #   m2 <- rbind(m2[!needs_splitting,,drop=FALSE], split_back)
  # }
  
  # ignore paralog
  missing <- c(missing, paralogs)
  
  # ignore empty rows
  m1 <- m1[(rowSums(m1!="", na.rm = TRUE) + rowSums(is.na(m1), na.rm = TRUE))>0,]
  m2 <- m2[(rowSums(m2!="", na.rm = TRUE) + rowSums(is.na(m2), na.rm = TRUE))>0,]
  
  # ignore rows made up of only unknowns
  # m1 <- m1[rowSums(m1!="", na.rm = TRUE)>0,]
  # m2 <- m2[rowSums(m2!="", na.rm = TRUE)>0,]
  
  rownames(m1) <- apply(m1, 1, function(r) unique(r[r!=""]))
  
  # sort m2 by occupancy
  m2 <- m2[order(rowSums(m2!="", na.rm = TRUE), decreasing = TRUE),]
  
  # set split to NA
  m2[grepl(".*;.*", m2)] <- NA
  
  rownames(m2) <- apply(m2, 1, function(r) {
    tbl <- table(r, exclude=c(NA, ""))
    return(names(tbl)[[which.max(tbl)]])
  })
  
  # ignore missing
  m1 <- m1[!(rownames(m1) %in% missing),]
  m2 <- m2[!(rownames(m2) %in% missing),]

  comp_matrix <- matrix(NA, nrow = nrow(m2), ncol=2)
  temp_rownames <- rownames(m1)
  for (r in 1:nrow(m2)){
    hit <- which(rownames(m2)[[r]]==temp_rownames)
    if (length(hit)>0){
      hit <- hit[[1]]
      comp_matrix[r,] <- c(r, hit)
      temp_rownames[[hit]] <- NA
    } else {
      comp_matrix[r,] <- c(r, NA)
    }
  }
  
  keep <- !is.na(comp_matrix[,2])
  
  # total_error <- sum(m1[comp_matrix[keep,2],] != m2[comp_matrix[keep,1],], na.rm = TRUE)  +
  #       sum(is.na(m1[comp_matrix[keep,2],]) & (m2[comp_matrix[keep,1],]=="")) +
  #       sum((m1[comp_matrix[keep,2],]=="") & is.na(m2[comp_matrix[keep,1],]))
  # 
  # total_error <- total_error +
  #   sum(m2[!keep,]!="", na.rm = TRUE) + sum(is.na(m2[!keep,]), na.rm = TRUE) 
  # 
  # total_error <- total_error +
  #   sum(m1[-comp_matrix[keep,2],]!="", na.rm = TRUE) + sum(is.na(m1[-comp_matrix[keep,2],]), na.rm = TRUE) 
  
  total_error <- rowSums(m1[comp_matrix[keep,2],] != m2[comp_matrix[keep,1],], na.rm = TRUE)  +
        rowSums(is.na(m1[comp_matrix[keep,2],]) & (m2[comp_matrix[keep,1],]=="")) +
        rowSums((m1[comp_matrix[keep,2],]=="") & is.na(m2[comp_matrix[keep,1],]))
  
  missing_in_m2 <- rowSums(((m1[comp_matrix[keep,2],] != m2[comp_matrix[keep,1],])  &
           (m1[comp_matrix[keep,2],]!="") & 
           (m2[comp_matrix[keep,1],]==""))  , na.rm = TRUE)
  
  missed_in_anno <- sum((total_error==missing_in_m2) & (total_error>0))

  total_error <- sum(total_error>0)

  total_error <- total_error + sum(!keep)

  missing <- nrow(m1[-comp_matrix[keep,2],])

  total_error <- total_error + missing
 
  return(list(total_error=total_error, pg_size=nrow(m2), missing=missed_in_anno, unannotated=sum(!keep)))
}

```

Compare each inference approach to the simulated matrix and count the number of discrepancies.

```{r}
assem_results_df <- map_dfr(1:length(panaroo_pa), function(i){
  print(i)
  
  current_sim <- gsub(".*_pa_", "", names(panaroo_pa)[[i]])
  
  current_sim_pa <- sim_pa[gsub(".*_pa_", "", names(sim_pa))==gsub(
    "_fragmented", "", gsub("_contaminated", "", current_sim))][[1]]
  
  # Identify genes that have not been refound at all. 
  # These are likely issues with the original annotation and it is not possible to refind them, 
  # thus we ignore these discrepancies.
  if (grepl(".*art_assem.*", names(panaroo_pa)[[i]])){
    all_ids <- cf_assem_mapping$annotation[cf_assem_mapping$folder==gsub(
      ".*_pa_", "", current_sim)]
    missing_from_all <- unique(
      unlist(current_sim_pa)[!(unlist(current_sim_pa) %in% cf_assem_mapping$annotation[cf_assem_mapping$folder==gsub(
        ".*_pa_", "", current_sim)])])
  } else {
    all_ids <- assem_mapping$annotation[assem_mapping$folder==gsub(".*_pa_", "", current_sim)]
    missing_from_all <- unique(
      unlist(current_sim_pa)[!(unlist(current_sim_pa) %in% assem_mapping$annotation[assem_mapping$folder==gsub(
        ".*_pa_", "", current_sim)])])
  }
  
  missing_from_all <- missing_from_all[missing_from_all!=""]
  missing_from_all <- c(missing_from_all, 
                        all_ids[((!(all_ids %in% c(roary_pa[[i]]))) & 
                                   (!(all_ids %in% c(pirate_pa[[i]]))) & 
                                   (!(all_ids %in% c(panx_pa[[i]]))) &
                                   (!(all_ids %in% c(panaroo_pa[[i]]))))])
  missing <- missing_from_all
  
  roary_error <- count_errors(current_sim_pa, roary_pa[[i]], missing = missing, paralogs = paralogs)
  panx_error <- count_errors(current_sim_pa, panx_pa[[i]], missing = missing, paralogs = paralogs)
  pirate_error <- count_errors(current_sim_pa, pirate_pa[[i]], missing = missing, paralogs = paralogs)
  panaroo_error <- count_errors(current_sim_pa, panaroo_pa[[i]], missing = missing, paralogs = paralogs)

  df <- data.frame(sim=current_sim,
             roary_error=roary_error$total_error,
             panx_error=panx_error$total_error,
             pirate_error=pirate_error$total_error,
             panaroo_error=panaroo_error$total_error,
              
             sim_pg_size=nrow(current_sim_pa)-length(missing),
             roary_pg_size=roary_error$pg_size,
             panx_pg_size=panx_error$pg_size,
             pirate_pg_size=pirate_error$pg_size,
             panaroo_pg_size=panaroo_error$pg_size,
             
             roary_missing=roary_error$missing,
             panx_missing=panx_error$missing,
             pirate_missing=pirate_error$missing,
             panaroo_missing=panaroo_error$missing,
             
             roary_unanno=roary_error$unannotated,
             panx_unanno=panx_error$unannotated,
             pirate_unanno=pirate_error$unannotated,
             panaroo_unanno=panaroo_error$unannotated,
             
             stringsAsFactors = FALSE)
  # print(df)
  return(df)
})
```

Create some plots!

```{r}
assem_results_df$params <- gsub("_rep[0-9]", "", assem_results_df$sim)

keep <- grepl("_error|params", colnames(assem_results_df))
plotdf <- assem_results_df[,keep]
plotdf <- melt(plotdf, variable.name="method", value.name = "error count")
gr <- as.numeric(gsub("_lr_.*","",gsub(".*_gr_","",plotdf$params)))
lr <- as.numeric(gsub("_mu_.*","",gsub(".*_lr_","",plotdf$params)))
mu <- as.numeric(gsub("_.*","",gsub(".*_mu_","",plotdf$params)))
plotdf$param_summary <- paste(paste(paste("Gain/Loss ratio: ", gr/lr, sep = ""), 
                              "\n Mutation rate: ", sep = ""), 
                              mu, sep = "")
plotdf$method <- gsub("_error", "", plotdf$method)

ggplot(plotdf[!grepl("contam|frag", plotdf$params),], aes(x=method, y=`error count`, col=method)) + 
  geom_point(size=2) +
  facet_wrap(~param_summary, nrow = 1)  +
  ylab("total error count") +
  theme_bw(base_size = 14)
```

Now plot more difficult scenarios

```{r}
plotdf <- assem_results_df[,!grepl("sim_pg_size", colnames(assem_results_df))]
plotdf <- melt(plotdf, id.vars=c("sim", "params"))
plotdf$method <- gsub("_.*", "", plotdf$variable)
plotdf$variable <- gsub(".*_", "", plotdf$variable)
plotdf <- plotdf[plotdf$variable!="size",]
plotdf$variable[plotdf$variable=="error"] <- "total errors"
plotdf$variable[plotdf$variable=="missing"] <- "missing genes"
plotdf$variable[plotdf$variable=="unanno"] <- "accessory inflation"
plotdf$variable <- factor(plotdf$variable, 
                          levels = c("total errors","missing genes","accessory inflation"))

contam_gg <- ggplot(plotdf[grepl("contam", plotdf$params),], aes(x=method, y=value, col=method)) +
  geom_point(size=2) +
  facet_wrap(~ variable) +
  theme_bw(base_size = 14) +
  xlab("") +
  ylab("count") +
  ggtitle("Contamination") + theme(plot.title = element_text(hjust = 0.5))
# contam_gg

frag_gg <- ggplot(plotdf[grepl("frag", plotdf$params),], aes(x=method, y=value, col=method)) +
  geom_point(size=2) +
  facet_wrap(~ variable) +
  theme_bw(base_size = 14) +
  xlab("") +
  ylab("count") +
  ggtitle("Fragmentation") + 
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none") 
# frag_gg

contam_gg + frag_gg + patchwork::plot_layout(ncol = 1)
```
